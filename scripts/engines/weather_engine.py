"""
Weather Arbitrage Engine - NWS API + Kalshi Series

EDGE SOURCE: National Weather Service is the official settlement source for Kalshi weather markets.
If NWS forecast says 90% chance of 40Â°F+ high, but Kalshi "above 40Â°" trading at 50Â¢ â†’ 40% edge.

KALSHI SERIES:
  KXHIGHNY  - NYC daily high temperature
  KXHIGHCHI - Chicago daily high temperature
  KXHIGHMIA - Miami daily high temperature

DATA: FREE - https://api.weather.gov (NWS is settlement source!)
"""

import requests
from datetime import datetime, timedelta
import sys
import os

sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', '..'))
from src.kalshi_feed import get_weather_markets, get_kalshi_event_url


class WeatherEngine:
    def __init__(self):
        self.base_url = "https://api.weather.gov"

        # NWS gridpoints for cities with Kalshi markets
        self.cities = {
            'NYC': {'office': 'OKX', 'gridX': 33, 'gridY': 37},
            'Chicago': {'office': 'LOT', 'gridX': 76, 'gridY': 74},
            'Miami': {'office': 'MFL', 'gridX': 110, 'gridY': 50},
        }

    def get_nws_forecast(self, city):
        """
        Fetch NWS hourly forecast and extract high temp predictions.
        Returns forecast highs for today and tomorrow.
        """
        try:
            grid = self.cities[city]
            url = f"{self.base_url}/gridpoints/{grid['office']}/{grid['gridX']},{grid['gridY']}/forecast/hourly"

            response = requests.get(url, headers={'User-Agent': 'KalshiEdgeFinder/1.0'}, timeout=15)
            response.raise_for_status()

            data = response.json()
            periods = data['properties']['periods']

            # Group temps by date
            daily_highs = {}
            for p in periods:
                dt = datetime.fromisoformat(p['startTime'].replace('Z', '+00:00'))
                date_str = dt.strftime('%Y-%m-%d')
                temp = p['temperature']
                if date_str not in daily_highs or temp > daily_highs[date_str]:
                    daily_highs[date_str] = temp

            return daily_highs

        except Exception as e:
            print(f"    âš ï¸ NWS fetch error for {city}: {e}")
            return {}

    def find_opportunities(self, kalshi_markets=None):
        """
        Compare NWS forecasts to Kalshi temperature markets.
        Uses get_weather_markets() from kalshi_feed.py to get real market data.

        Returns list of opportunities with edge > 10%.
        """
        # Fetch Kalshi weather markets directly by series ticker
        if kalshi_markets is None:
            kalshi_markets = get_weather_markets()

        if not kalshi_markets:
            print("    No Kalshi weather markets found.")
            return []

        opportunities = []

        # Get NWS forecasts for all cities
        forecasts = {}
        for city in self.cities:
            highs = self.get_nws_forecast(city)
            if highs:
                forecasts[city] = highs
                print(f"    ðŸ“¡ NWS {city}: {highs}")

        # Match against Kalshi markets
        now = datetime.now()
        today_str = now.strftime('%Y-%m-%d')

        for market in kalshi_markets:
            city = market.get('_city', '')
            if city not in forecasts:
                continue

            # Parse the market's date from event_ticker (e.g., KXHIGHNY-26FEB23)
            event_ticker = market.get('event_ticker', '')
            market_date = self._parse_event_date(event_ticker)
            if not market_date:
                continue

            # â”€â”€ EXPIRATION FILTER â”€â”€
            # Skip markets whose date has passed
            if market_date < today_str:
                continue
            # Skip same-day markets after 6PM (high temp already recorded)
            if market_date == today_str and now.hour >= 18:
                continue

            # Get the NWS forecast high for that date
            forecast_high = forecasts[city].get(market_date)
            if forecast_high is None:
                continue

            # Market structure: floor_strike = "above X", cap_strike = "below X"
            floor = market.get('floor_strike')
            cap = market.get('cap_strike')
            yes_ask = market.get('yes_ask', 0)
            ticker = market.get('ticker', '')
            title = market.get('title', '')
            subtitle = market.get('subtitle', '')
            expiration = market.get('expiration_time', '')

            if yes_ask == 0:
                continue

            # Calculate our probability based on NWS forecast
            edge = None
            action = None
            nws_prob = None

            if floor is not None and cap is None:
                # "Above X" market â€” e.g. "Will the high temp be >40Â°?"
                if forecast_high > floor + 3:
                    nws_prob = 90  # Very confident above
                elif forecast_high > floor:
                    nws_prob = 75  # Moderately confident above
                elif forecast_high > floor - 2:
                    nws_prob = 40  # On the edge
                else:
                    nws_prob = 10  # Unlikely above

                edge = nws_prob - yes_ask
                action = 'BUY YES' if edge > 0 else 'BUY NO'

            elif cap is not None and floor is None:
                # "Below X" market â€” e.g. "Will the high temp be <33Â°?"
                if forecast_high < cap - 3:
                    nws_prob = 90
                elif forecast_high < cap:
                    nws_prob = 75
                elif forecast_high < cap + 2:
                    nws_prob = 40
                else:
                    nws_prob = 10

                edge = nws_prob - yes_ask
                action = 'BUY YES' if edge > 0 else 'BUY NO'

            elif floor is not None and cap is not None:
                # Range market â€” e.g. "Will the high temp be 35-36Â°?"
                if floor <= forecast_high <= cap:
                    nws_prob = 70  # In range
                elif abs(forecast_high - (floor + cap) / 2) <= 2:
                    nws_prob = 35  # Near range
                else:
                    nws_prob = 5   # Out of range

                edge = nws_prob - yes_ask
                action = 'BUY YES' if edge > 0 else 'BUY NO'

            if edge is not None and abs(edge) > 10:
                kalshi_url = get_kalshi_event_url(event_ticker)
                opportunities.append({
                    'engine': 'Weather',
                    'asset': city,
                    'market_title': f"{title} ({subtitle})" if subtitle else title,
                    'market_ticker': ticker,
                    'event_ticker': event_ticker,
                    'action': action,
                    'model_probability': nws_prob,
                    'market_price': yes_ask,
                    'edge': abs(edge),
                    'confidence': nws_prob,
                    'reasoning': f"NWS forecasts {forecast_high}Â°F high for {city} on {market_date}. "
                                 f"Model says {nws_prob}% prob, market at {yes_ask}Â¢.",
                    'data_source': 'NWS Official API (Settlement Source)',
                    'kalshi_url': kalshi_url,
                    'market_date': market_date,
                    'expiration': expiration or market_date,
                })

        return opportunities

    def _parse_event_date(self, event_ticker):
        """Parse date from event ticker like KXHIGHNY-26FEB23 â†’ 2026-02-23"""
        try:
            parts = event_ticker.split('-')
            if len(parts) >= 2:
                date_part = parts[1]  # e.g., "26FEB23"
                # Parse: YY + MON + DD
                year = 2000 + int(date_part[:2])
                month_str = date_part[2:5]
                day = int(date_part[5:])
                months = {'JAN': 1, 'FEB': 2, 'MAR': 3, 'APR': 4, 'MAY': 5, 'JUN': 6,
                           'JUL': 7, 'AUG': 8, 'SEP': 9, 'OCT': 10, 'NOV': 11, 'DEC': 12}
                month = months.get(month_str.upper(), 0)
                if month:
                    return f"{year}-{month:02d}-{day:02d}"
        except:
            pass
        return None


if __name__ == "__main__":
    print("Running Weather Engine...")
    engine = WeatherEngine()

    # Show NWS forecasts
    for city in engine.cities:
        highs = engine.get_nws_forecast(city)
        if highs:
            for date, temp in sorted(highs.items())[:2]:
                print(f"  {city} {date}: High {temp}Â°F")

    # Find opportunities
    opps = engine.find_opportunities()
    print(f"\n  Found {len(opps)} weather opportunities")
    for o in opps:
        print(f"  {o['asset']}: {o['action']} | Edge: {o['edge']:.1f}% | {o['reasoning'][:80]}")
        print(f"    â†’ {o['kalshi_url']}")
